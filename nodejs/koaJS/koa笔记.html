<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <script>

        /*
            1.概念
                koa是Express的下一代基于Node.js的web框架,它支持异步操作（async/await），去掉了express的回调
                express写法:
                    app.get('/test', function (req, res) {
                        fs.readFile('/file1', function (err, data) {
                            if (err) {
                                res.status(500).send('read file1 error');
                            }
                        });
                    });
                koa写法：
                    app.use(async (ctx, next) => {
                        await next();
                        var data = await doReadFile();
                        ctx.response.type = 'text/plain';
                        ctx.response.body = data;
                    });

            2.用法
                --1.安装
                    cnpm init -y //初始化项目
                    cnpm i koa koa-static koa-better-body koa-convert koa-router -D
                --2.使用
                    //koa中不存在server.get() server.post()等。只存在server.use(()=>{}),且use不存在地址，只有回调(ctx,next)=>{}
                    //要区分出get/post等，需要进行下载引用中间件koa-router
                    const koa=require('koa');
                    const router=require('koa-router')

                    let server=new koa();
                    server.listen(8080)
                    
                    let r1=router;  //创建路由
                    server.use(r1.routes())  //使用路由
                    r1.get('/a',async(ctx,next)=>{
                        //ctx:常用的存在res,response,req,request
                        //res,req：原生nodejs中的res,req
                        //request,response：koa封装过的req,res
                        //一般使用的是ctx.response,ctx.request

                        ctx.response.body='响应内容'  //类似于express的res.send()   
                        ctx.response.set('a',12)  //设置请求的header 
                        ctx.response.status=403   //设置状态码
                        ctx.request.headers       //获取请求的header
                        ...
                    }) //路由列表
                    r1.post('/a',async(ctx,next)=>{})

            3.访问静态文件
                --1.使用koa自带的kao-static中间件
                    --缺点：自带的static中间件读取文件没有进行缓存压缩，快被淘汰了
                --2.使用koa-static-cache中间件
                    --存在缓存，压缩等功能
                    --使用
                        --安装
                            cnpm i koa-static-cache -D
                        --使用
                            const path=require('path');
                            const staticCache=require('koa-static-cache');
                            server.use(staticCache(path.resolve('./www')))

            4.获取数据get post 文件数据
                --get请求获取参数
                    ---获取query参数
                        server.use(async(ctx,next)=>{
                            console.log(ctx.request.query)
                        })
                    ---获取路由参数
                        r1.get('/api/:name/:age',async(ctx,next)=>{
                            console.log(ctx.params)  //获取其中的name,age的路由名
                            //----/api/qq/www    结果   {name:'qq',age:'www'}
                        })
                --post请求获取数据
                    --使用koa-better-body中间件
                    --使用koa-convert中间件 将其他中间件升级到koa的最新版
                    const betterBody=require('koa-better-body');
                    const convert=require('koa-convert');
                    const pathlib=require('path');

                    server.use(convert(betterBody({
                        uploadDir:pathlib.resolve('./upload'),   //设置提交文件的保存路径
                        keepExtensions:true   //设置是否保存上传文件的拓展名
                    })))

                    server.use(async(ctx,next)=>{
                        console.log(ctx.request.fields);  //获取普通数据+文件基本信息
                        console.log(ctx.request.files);   //获取文件数据
                    })
            
            5.koa获取cookie和设置session
                ----设置和获取：
                    server.use(async(ctx,next)=>{
                        console.log(ctx.cookies.get('a'))
                        //ctx.cookies.get('cookie的名称')-----获取cookie
                        ctx.cookies.set('b',5,{
                            maxAge:86400*1000    //设置有效期一天后  单位：毫秒
                        });
                        //ctx.cookies.set('cookie的名称',cookie的值);----设置cookie
                    })
                ----设置session（使用中间件koa-session）
                    1.安装 
                        cnpm i koa-session -D
                    2.使用
                        const session=require('koa-session');
                        server.keys=[    //增加session的安全性
                            'jdfkn',
                            'jdfgkdf'
                        ]
                        server.use(session({},server)); //使用koa-session的中间件
                        server.use(async ctx=>{
                            if(!ctx.session['count']){
                                ctx.session.count=1
                            }else{
                                ctx.session.count++
                            }
                            ctx.response.body=`第${ctx.session.count}次访问网站`
                        })
            
            6.koa的数据库(安装nodejs的mysql模块)
                ---1.安装
                    数据库：(推荐使用mysql模块)
                    cnpm install mysql -S
                ---2.使用
                    const mysql=require('mysql');
                    const db=mysql.createConnection({
                        host:'localhost',
                        port:'3306',
                        user:'root',
                        passwoed:'root',
                        database:'test'    //需要连接的数据库名
                    })
                    server.use(async ctx=>{
                        db.query('SELECT * FROM user_table',(err,data,fileds)=>{   //查询连接的数据库下的表的数据
                            if(err){
                                console.log(err)
                            }else{
                                console.log(data)
                            }
                        })
                    })

            7.模板引擎:
                1.安装
                    cnpm i koa-pug koa-ejs -D
                2.使用
                    ejs:
                    const ejs=require('koa-ejs');
                    ejs(server,{
                        root:pathlib.resolve('读取的html文件'),
                        layout:false,
                        viewExt:'ejs'  //文件模板的拓展名.ejs
                    });
                    server.use(async ctx=>{
                        await ctx.render('1',{a:12,name:'1we'})
                        await ctx.render('1文件路径',{a:12需要渲染的模板数据，对象格式})
                    })
                    渲染的html文件：(通过<%=xxx%>渲染数据)
                        <span><%=a%></span>
                        <div><%=name%></div>

                    
         */
    </script>
</body>
</html>